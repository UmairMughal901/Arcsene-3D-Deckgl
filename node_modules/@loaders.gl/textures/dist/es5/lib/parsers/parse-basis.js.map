{"version":3,"sources":["../../../../src/lib/parsers/parse-basis.js"],"names":["OutputFormat","etc1","basisFormat","compressed","etc2","bc1","format","GL","COMPRESSED_RGB_S3TC_DXT1_EXT","bc3","COMPRESSED_RGBA_S3TC_DXT5_EXT","bc4","bc5","rgba32","rgb565","bgr565","rgba4444","parseBasis","data","options","BasisFile","basisFile","Uint8Array","startTranscoding","imageCount","getNumImages","images","imageIndex","levelsCount","getNumLevels","levels","levelIndex","push","transcodeImage","close","delete","getBasisOptions","hasAlpha","basis","alpha","noAlpha","toLowerCase","width","getImageWidth","height","getImageHeight","getHasAlpha","decodedSize","getImageTranscodedSizeInBytes","decodedData"],"mappings":";;;;;;;;;;;;;;;AAAA;;AACA;;AAEA,IAAMA,YAAY,GAAG;AACnBC,EAAAA,IAAI,EAAE;AAACC,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GADa;AAEnBC,EAAAA,IAAI,EAAE;AAACF,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GAFa;AAGnBE,EAAAA,GAAG,EAAE;AAACH,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE,IAA7B;AAAmCG,IAAAA,MAAM,EAAEC,gBAAGC;AAA9C,GAHc;AAInBC,EAAAA,GAAG,EAAE;AAACP,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE,IAA7B;AAAmCG,IAAAA,MAAM,EAAEC,gBAAGG;AAA9C,GAJc;AAKnBC,EAAAA,GAAG,EAAE;AAACT,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GALc;AAMnBS,EAAAA,GAAG,EAAE;AAACV,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GANc;AAOnB,wBAAsB;AAACD,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GAPH;AAQnB,YAAU;AAACD,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GARS;AASnB,kBAAgB;AAACD,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GATG;AAUnB,mBAAiB;AAACD,IAAAA,WAAW,EAAE,CAAd;AAAiBC,IAAAA,UAAU,EAAE;AAA7B,GAVE;AAWnB,cAAY;AAACD,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAXO;AAYnB,aAAW;AAACD,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAZQ;AAanB,iCAA+B;AAACD,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAbZ;AAcnBU,EAAAA,MAAM,EAAE;AAACX,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAdW;AAenBW,EAAAA,MAAM,EAAE;AAACZ,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAfW;AAgBnBY,EAAAA,MAAM,EAAE;AAACb,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B,GAhBW;AAiBnBa,EAAAA,QAAQ,EAAE;AAACd,IAAAA,WAAW,EAAE,EAAd;AAAkBC,IAAAA,UAAU,EAAE;AAA9B;AAjBS,CAArB;;SAoB8Bc,U;;;;;0EAAf,iBAA0BC,IAA1B,EAAgCC,OAAhC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACa,wCAAgBA,OAAhB,CADb;;AAAA;AAAA;AACNC,YAAAA,SADM,yBACNA,SADM;AAEPC,YAAAA,SAFO,GAEK,IAAID,SAAJ,CAAc,IAAIE,UAAJ,CAAeJ,IAAf,CAAd,CAFL;AAAA;;AAAA,gBAKNG,SAAS,CAACE,gBAAV,EALM;AAAA;AAAA;AAAA;;AAAA,6CAMF,IANE;;AAAA;AASLC,YAAAA,UATK,GASQH,SAAS,CAACI,YAAV,EATR;AAULC,YAAAA,MAVK,GAUI,EAVJ;;AAYX,iBAASC,UAAT,GAAsB,CAAtB,EAAyBA,UAAU,GAAGH,UAAtC,EAAkDG,UAAU,EAA5D,EAAgE;AACxDC,cAAAA,WADwD,GAC1CP,SAAS,CAACQ,YAAV,CAAuBF,UAAvB,CAD0C;AAExDG,cAAAA,MAFwD,GAE/C,EAF+C;;AAI9D,mBAASC,UAAT,GAAsB,CAAtB,EAAyBA,UAAU,GAAGH,WAAtC,EAAmDG,UAAU,EAA7D,EAAiE;AAC/DD,gBAAAA,MAAM,CAACE,IAAP,CAAYC,cAAc,CAACZ,SAAD,EAAYM,UAAZ,EAAwBI,UAAxB,EAAoCZ,OAApC,CAA1B;AACD;;AAEDO,cAAAA,MAAM,CAACM,IAAP,CAAYF,MAAZ;AACD;;AArBU,6CAuBJJ,MAvBI;;AAAA;AAAA;AAyBXL,YAAAA,SAAS,CAACa,KAAV;AACAb,YAAAA,SAAS,CAACc,MAAV;AA1BW;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA8Bf,SAASC,eAAT,CAAyBjB,OAAzB,EAAkCkB,QAAlC,EAA4C;AAC1C,MAAI/B,MAAM,GAAGa,OAAO,IAAIA,OAAO,CAACmB,KAAnB,IAA4BnB,OAAO,CAACmB,KAAR,CAAchC,MAAvD;;AACA,MAAI,sBAAOA,MAAP,MAAkB,QAAtB,EAAgC;AAC9BA,IAAAA,MAAM,GAAG+B,QAAQ,GAAG/B,MAAM,CAACiC,KAAV,GAAkBjC,MAAM,CAACkC,OAA1C;AACD;;AAEDlC,EAAAA,MAAM,GAAGA,MAAM,CAACmC,WAAP,EAAT;AACA,SAAOzC,YAAY,CAACM,MAAD,CAAnB;AACD;;AAED,SAAS2B,cAAT,CAAwBZ,SAAxB,EAAmCM,UAAnC,EAA+CI,UAA/C,EAA2DZ,OAA3D,EAAoE;AAClE,MAAMuB,KAAK,GAAGrB,SAAS,CAACsB,aAAV,CAAwBhB,UAAxB,EAAoCI,UAApC,CAAd;AACA,MAAMa,MAAM,GAAGvB,SAAS,CAACwB,cAAV,CAAyBlB,UAAzB,EAAqCI,UAArC,CAAf;AAGA,MAAMM,QAAQ,GAAGhB,SAAS,CAACyB,WAAV,EAAjB;;AAGA,yBAA0CV,eAAe,CAACjB,OAAD,EAAUkB,QAAV,CAAzD;AAAA,MAAOlC,UAAP,oBAAOA,UAAP;AAAA,MAAmBG,MAAnB,oBAAmBA,MAAnB;AAAA,MAA2BJ,WAA3B,oBAA2BA,WAA3B;;AAEA,MAAM6C,WAAW,GAAG1B,SAAS,CAAC2B,6BAAV,CAAwCrB,UAAxC,EAAoDI,UAApD,EAAgE7B,WAAhE,CAApB;AACA,MAAM+C,WAAW,GAAG,IAAI3B,UAAJ,CAAeyB,WAAf,CAApB;;AAEA,MAAI,CAAC1B,SAAS,CAACY,cAAV,CAAyBgB,WAAzB,EAAsCtB,UAAtC,EAAkDI,UAAlD,EAA8D7B,WAA9D,EAA2E,CAA3E,EAA8E,CAA9E,CAAL,EAAuF;AACrF,WAAO,IAAP;AACD;;AAED,SAAO;AAELwC,IAAAA,KAAK,EAALA,KAFK;AAGLE,IAAAA,MAAM,EAANA,MAHK;AAIL1B,IAAAA,IAAI,EAAE+B,WAJD;AAKL9C,IAAAA,UAAU,EAAVA,UALK;AASLkC,IAAAA,QAAQ,EAARA,QATK;AAUL/B,IAAAA,MAAM,EAANA;AAVK,GAAP;AAYD","sourcesContent":["import {loadBasisModule} from './basis-module-loader';\nimport {GL} from '../gl-constants';\n\nconst OutputFormat = {\n  etc1: {basisFormat: 0, compressed: true},\n  etc2: {basisFormat: 1, compressed: true},\n  bc1: {basisFormat: 2, compressed: true, format: GL.COMPRESSED_RGB_S3TC_DXT1_EXT},\n  bc3: {basisFormat: 3, compressed: true, format: GL.COMPRESSED_RGBA_S3TC_DXT5_EXT},\n  bc4: {basisFormat: 4, compressed: true},\n  bc5: {basisFormat: 5, compressed: true},\n  'bc7-m6-opaque-only': {basisFormat: 6, compressed: true},\n  'bc7-m5': {basisFormat: 7, compressed: true},\n  'pvrtc1-4-rgb': {basisFormat: 8, compressed: true},\n  'pvrtc1-4-rgba': {basisFormat: 9, compressed: true},\n  'astc-4x4': {basisFormat: 10, compressed: true},\n  'atc-rgb': {basisFormat: 11, compressed: true},\n  'atc-rgba-interpolated-alpha': {basisFormat: 12, compressed: true},\n  rgba32: {basisFormat: 13, compressed: false},\n  rgb565: {basisFormat: 14, compressed: false},\n  bgr565: {basisFormat: 15, compressed: false},\n  rgba4444: {basisFormat: 16, compressed: false}\n};\n\nexport default async function parseBasis(data, options) {\n  const {BasisFile} = await loadBasisModule(options);\n  const basisFile = new BasisFile(new Uint8Array(data));\n\n  try {\n    if (!basisFile.startTranscoding()) {\n      return null;\n    }\n\n    const imageCount = basisFile.getNumImages();\n    const images = [];\n\n    for (let imageIndex = 0; imageIndex < imageCount; imageIndex++) {\n      const levelsCount = basisFile.getNumLevels(imageIndex);\n      const levels = [];\n\n      for (let levelIndex = 0; levelIndex < levelsCount; levelIndex++) {\n        levels.push(transcodeImage(basisFile, imageIndex, levelIndex, options));\n      }\n\n      images.push(levels);\n    }\n\n    return images;\n  } finally {\n    basisFile.close();\n    basisFile.delete();\n  }\n}\n\nfunction getBasisOptions(options, hasAlpha) {\n  let format = options && options.basis && options.basis.format;\n  if (typeof format === 'object') {\n    format = hasAlpha ? format.alpha : format.noAlpha;\n  }\n\n  format = format.toLowerCase();\n  return OutputFormat[format];\n}\n\nfunction transcodeImage(basisFile, imageIndex, levelIndex, options) {\n  const width = basisFile.getImageWidth(imageIndex, levelIndex);\n  const height = basisFile.getImageHeight(imageIndex, levelIndex);\n\n  // See https://github.com/BinomialLLC/basis_universal/pull/83\n  const hasAlpha = basisFile.getHasAlpha(/* imageIndex, levelIndex */);\n\n  // Check options for output format etc\n  const {compressed, format, basisFormat} = getBasisOptions(options, hasAlpha);\n\n  const decodedSize = basisFile.getImageTranscodedSizeInBytes(imageIndex, levelIndex, basisFormat);\n  const decodedData = new Uint8Array(decodedSize);\n\n  if (!basisFile.transcodeImage(decodedData, imageIndex, levelIndex, basisFormat, 0, 0)) {\n    return null;\n  }\n\n  return {\n    // standard loaders.gl image category payload\n    width,\n    height,\n    data: decodedData,\n    compressed,\n\n    // Additional fields\n    // Add levelSize field.\n    hasAlpha,\n    format\n  };\n}\n"],"file":"parse-basis.js"}